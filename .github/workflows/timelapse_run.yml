name: Build and Run Timelapse Example

on:
  workflow_dispatch:
  push:
    branches: [ main, ki ]
    paths:
      - 'src/**'
      - 'examples/pixel_timelapse/**'
      - 'CMakeLists.txt'
      - 'scripts/make_timelapse.sh'
      - '.github/workflows/timelapse_run.yml'

permissions:
  contents: read

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ ffmpeg libomp-dev
    
    - name: Run timelapse generation script
      run: |
        chmod +x scripts/make_timelapse.sh
        # Run with CI-appropriate parameters: 128x128, 100 steps
        bash scripts/make_timelapse.sh 128 128 100 42
    
    - name: Upload timelapse artifact
      uses: actions/upload-artifact@v4
      with:
        name: timelapse-video
        path: examples/pixel_timelapse/timelapse_colored_core.mp4
        retention-days: 30
    
    - name: Upload sample frames
      uses: actions/upload-artifact@v4
      with:
        name: sample-frames
        path: |
          examples/pixel_timelapse/frames_png_core/frame_0000.png
          examples/pixel_timelapse/frames_png_core/frame_0050.png
          examples/pixel_timelapse/frames_png_core/frame_0099.png
        retention-days: 30
